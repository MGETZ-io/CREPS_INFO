<script>
  const validCodes = {
    "1234567890": "Maxim Getz",
    "0987654321": "Lena Scholz",
    "1111222233": "Tom Müller"
    // Weitere Codes hier hinzufügen
  };

  let input = "";
  let pendingLogin = null; // für zwischengespeicherte Daten

  function updateDisplay() {
    document.getElementById("codeDisplay").textContent = input.padEnd(10, "_");
  }

  function handleKey(num) {
    if (input.length < 10) {
      input += num;
      updateDisplay();
    }
    if (input.length === 10) {
      checkCode(input);
    }
  }

  function checkCode(code) {
    const name = validCodes[code];
    if (name) {
      // Warte auf doppelte Bestätigung, speichere temporär
      pendingLogin = { name, code, time: new Date() };
      showConfirmPopup(name);
    } else {
      showErrorPopup("❌ Ungültiger Code");
    }
  }

  function showConfirmPopup(name) {
    const popup = document.getElementById("popup");
    const overlay = document.getElementById("overlay");
    popup.innerHTML = `
      <div class="checkmark"></div>
      <p>✅ Bitte bestätigen, <strong>${name}</strong></p>
      <button id="confirmBtn" style="font-size:1.5rem; padding: 0.5rem 2rem; border:none; border-radius:10px; background:#34c759; color:white; cursor:pointer;">
        Bestätigen
      </button>
      <p style="font-size: 0.9rem; margin-top: 0.5rem; color: #555;">Doppelt klicken wie bei Apple Pay</p>
    `;
    popup.style.display = "block";
    overlay.style.display = "block";

    let confirmCount = 0;
    const btn = document.getElementById("confirmBtn");
    btn.onclick = () => {
      confirmCount++;
      if (confirmCount === 2) {
        const { name, time } = pendingLogin;
        saveLogin(name, time.toISOString());
        showSuccessPopup(name, time.toLocaleTimeString("de-DE"));
        pendingLogin = null;
      } else {
        btn.textContent = "Noch einmal bestätigen";
        btn.style.background = "#28a745"; // etwas dunkleres grün
      }
    };
  }

  function showSuccessPopup(name, time) {
    const popup = document.getElementById("popup");
    const overlay = document.getElementById("overlay");
    popup.innerHTML = `
      <div class="checkmark"></div>
      ✅ Willkommen, <strong>${name}</strong><br>
      Eingeloggt um <strong>${time}</strong>
    `;
    popup.style.display = "block";
    overlay.style.display = "block";

    setTimeout(() => {
      popup.style.display = "none";
      overlay.style.display = "none";
      input = "";
      updateDisplay();
    }, 4000);
  }

  function showErrorPopup(msg) {
    const popup = document.getElementById("popup");
    const overlay = document.getElementById("overlay");
    popup.innerHTML = `<div class="error">${msg}</div>`;
    popup.style.display = "block";
    overlay.style.display = "block";

    setTimeout(() => {
      popup.style.display = "none";
      overlay.style.display = "none";
      input = "";
      updateDisplay();
    }, 2500);
  }

  function saveLogin(name, isoTime) {
    const dateKey = isoTime.split("T")[0];
    const logs = JSON.parse(localStorage.getItem("loginsByDay") || "{}");
    const time = new Date(isoTime).toLocaleTimeString("de-DE");

    if (!logs[dateKey]) logs[dateKey] = [];
    logs[dateKey].push({ name, time });

    localStorage.setItem("loginsByDay", JSON.stringify(logs));
  }

  function createKeypad() {
    const keypad = document.getElementById("keypad");
    for (let i = 1; i <= 9; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = "btn";
      btn.onclick = () => handleKey(i.toString());
      keypad.appendChild(btn);
    }
    const zero = document.createElement("button");
    zero.textContent = "0";
    zero.className = "btn";
    zero.onclick = () => handleKey("0");

    keypad.appendChild(document.createElement("div"));
    keypad.appendChild(zero);
    keypad.appendChild(document.createElement("div"));
  }

  document.addEventListener("keydown", (e) => {
    if (e.key >= "0" && e.key <= "9") {
      handleKey(e.key);
    }
    if (e.key === "Backspace") {
      input = input.slice(0, -1);
      updateDisplay();
    }
  });

  createKeypad();
  updateDisplay();
  document.getElementById("hiddenInput").focus();
</script>
